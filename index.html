<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Your Own Story</title>

<style>
* {box-sizing: border-box}

body {
  margin: 0;
  font-family: Arial, Helvetica, sans-serif;
  background: linear-gradient(135deg, #6a5acd, #7b68ee);
  display: flex;
  justify-content: center;
  padding: 20px;
}

.container {
  background: white;
  width: 100%;
  max-width: 600px;
  padding: 20px;
  border-radius: 20px;
  overflow: hidden;
}

h2 {
  margin-top: 0;
}

/* √î nh·∫≠p t·ª± xu·ªëng d√≤ng v√† m·ªü r·ªông theo chi·ªÅu d·ªçc */
textarea {
  resize: vertical; /* cho ph√©p m·ªü r·ªông chi·ªÅu d·ªçc */
  min-height: 100px; /* chi·ªÅu cao t·ªëi thi·ªÉu */
  max-height: 300px; /* gi·ªõi h·∫°n chi·ªÅu cao */
  overflow-y: auto; /* cu·ªôn d·ªçc khi v∆∞·ª£t qu√° */
  white-space: pre-wrap; /* t·ª± xu·ªëng d√≤ng theo n·ªôi dung */
  word-wrap: break-word; /* chia nh·ªè t·ª´ d√†i */
  width: 100%;
  padding: 14px;
  border-radius: 12px;
  border: 1px solid #ccc;
  font-size: 16px;
  margin-bottom: 10px;
}

input {
  width: 100%;
  padding: 14px;
  border-radius: 12px;
  border: 1px solid #ccc;
  font-size: 16px;
  margin-bottom: 10px;
}

button {
  width: 100%;
  padding: 14px;
  border: none;
  border-radius: 12px;
  background: #6a5acd;
  color: white;
  font-size: 18px;
  cursor: pointer;
}

button:hover {
  background: #5941c9;
}

.post {
  background: #f1f1f1;
  padding: 15px;
  border-radius: 12px;
  margin-top: 12px;
}

.name {
  font-weight: bold;
  margin-bottom: 6px;
}

.content {
  white-space: pre-wrap; /* gi·ªØ xu·ªëng d√≤ng trong n·ªôi dung */
  word-wrap: break-word;
}

/* N√∫t X√≥a */
.deleteBtn {
  margin-top: 8px;
  background: #ff4d4d;
  border: none;
  color: white;
  padding: 6px 10px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
}

.deleteBtn:hover {
  background: #e60000;
}

.moreBtn {
  color: #6a5acd;
  cursor: pointer;
  font-size: 14px;
  margin-top: 6px;
  display: inline-block;
}
</style>
</head>
<body>

<div class="container">
  <h2>üí¨ Your Own Story</h2>

  <input id="nicknameInput" placeholder="Nickname (Optional)" />
  <textarea id="statusInput" placeholder="Your idea"></textarea>
  <button onclick="postStatus()">Post</button>

  <div id="posts"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* üî• C·∫•u h√¨nh Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyC3Yu_mU38Ru7PIEGR-2rNSo5FoelowrUQ",
  authDomain: "tuanhh-f16a9.firebaseapp.com",
  projectId: "tuanhh-f16a9",
  storageBucket: "tuanhh-f16a9.appspot.com",
  messagingSenderId: "71969140903",
  appId: "1:71969140903:web:49986baacfbbd1f9e8ab82"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* üîë M√£ qu·∫£n tr·ªã */
const ADMIN_KEY = "123456"; // ƒë·ªïi m√£ b√≠ m·∫≠t
const params = new URLSearchParams(window.location.search);
const isAdmin = params.get("admin") === ADMIN_KEY;

/* üöÄ ƒêƒÉng tr·∫°ng th√°i */
window.postStatus = async function() {
  const text = document.getElementById("statusInput").value.trim();
  let nickname = document.getElementById("nicknameInput").value.trim();

  if (text === "") {
    alert("Write Something!");
    return;
  }

  if (nickname === "") nickname = "Anonymous";

  await addDoc(collection(db, "statuses"), {
    text,
    nickname,
    time: serverTimestamp()
  });

  document.getElementById("statusInput").value = "";
}

/* üóë X√≥a tr·∫°ng th√°i */
window.deleteStatus = async function(id) {
  if (confirm("X√≥a h·∫£? üôÑ")) {
    await deleteDoc(doc(db, "statuses", id));
  }
}

/* Hi·ªÉn th·ªã d·ªØ li·ªáu theo th·ªùi gian th·ª±c */
const q = query(collection(db, "statuses"), orderBy("time", "desc"));

onSnapshot(q, (snapshot) => {
  const posts = document.getElementById("posts");
  posts.innerHTML = "";

  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    const div = document.createElement("div");
    div.className = "post";

    const time = data.time?.toDate().toLocaleString() ?? "";

    const fullText = data.text;
    const shortText = fullText.substring(0, 200);
    const needsToggle = fullText.length > 200;

    // T·∫°o ph·∫ßn t·ª≠ t√™n
    const nameDiv = document.createElement('div');
    nameDiv.className = 'name';
    nameDiv.textContent = data.nickname ?? "Anonymous";

    // T·∫°o ph·∫ßn t·ª≠ n·ªôi dung
    const contentDiv = document.createElement('div');
    contentDiv.className = 'content';

    // G√°n n·ªôi dung ban ƒë·∫ßu
    contentDiv.textContent = needsToggle ? shortText + "..." : fullText;

    // T·∫°o ph·∫ßn t·ª≠ th·ªùi gian
    const timeDiv = document.createElement('div');
    timeDiv.className = 'time';
    timeDiv.textContent = time;

    // Th√™m c√°c ph·∫ßn t·ª≠ v√†o div cha
    div.appendChild(nameDiv);
    div.appendChild(contentDiv);
    div.appendChild(timeDiv);

    // Th√™m n√∫t "Xem th√™m" n·∫øu c·∫ßn
    if (needsToggle) {
      const toggleSpan = document.createElement('span');
      toggleSpan.className = 'moreBtn';
      toggleSpan.textContent = 'Expand';
      div.appendChild(toggleSpan);

      let expanded = false;
      toggleSpan.onclick = () => {
        expanded = !expanded;
        if (expanded) {
          contentDiv.textContent = fullText; // hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß
          toggleSpan.textContent = 'Shorten';
        } else {
          contentDiv.textContent = shortText + "..."; // thu g·ªçn
          toggleSpan.textContent = 'Expand';
        }
      };
    }

    // N·∫øu l√† admin th√¨ th√™m n√∫t x√≥a
    if (isAdmin) {
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'deleteBtn';
      deleteBtn.textContent = '‚ùå Delete';
      deleteBtn.onclick = () => {
        deleteStatus(docSnap.id);
      };
      div.appendChild(deleteBtn);
    }

    // Th√™m b√†i vi·∫øt v√†o danh s√°ch
    posts.appendChild(div);
  });
});
</script>

</body>
</html>
