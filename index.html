<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<title>Journal of Speculative Worldbuilding</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
* {
  box-sizing: border-box;
  font-family: 'Inter', sans-serif;
}

body {
  margin: 0;
  background: linear-gradient(135deg, #6a5acd, #7b68ee);
  display: flex;
  justify-content: center;
  padding: 20px;
}

.container {
  background: white;
  width: 100%;
  max-width: 600px;
  padding: 20px;
  border-radius: 20px;
}

textarea,input,button { font-family: inherit; }

textarea {
  resize: vertical;
  min-height: 100px;
  max-height: 300px;
  width: 100%;
  padding: 14px;
  border-radius: 12px;
  border: 1px solid #ccc;
  font-size: 16px;
  margin-bottom: 10px;
}

input {
  width: 100%;
  padding: 14px;
  border-radius: 12px;
  border: 1px solid #ccc;
  font-size: 16px;
  margin-bottom: 10px;
}

button {
  width: 100%;
  padding: 14px;
  border: none;
  border-radius: 12px;
  background: #6a5acd;
  color: white;
  font-size: 18px;
  cursor: pointer;
  font-weight: 600;
  margin-bottom: 8px;
}

button:hover { background: #5941c9; }

.post {
  background: #f1f1f1;
  padding: 15px;
  border-radius: 12px;
  margin-top: 12px;
}

.name { font-weight: 600; margin-bottom: 6px; }

.content {
  white-space: pre-wrap;
  word-wrap: break-word;
}

.moreBtn {
  color: #6a5acd;
  cursor: pointer;
  font-size: 14px;
  margin-right: 12px;
}

.deleteBtn {
  margin-top: 8px;
  background: #ff4d4d;
  border: none;
  color: white;
  padding: 6px 10px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
}
</style>
</head>
<body>

<div class="container">
  <h2>ðŸ’¬ Write Your Own Story</h2>

  <input id="nicknameInput" placeholder="Nickname (Optional)" />
  <textarea id="statusInput" placeholder="Your idea"></textarea>

  <button onclick="postStatus()">Post</button>

  <div id="posts"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, collection, addDoc, query, orderBy,
  onSnapshot, serverTimestamp, deleteDoc, doc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* ðŸ”¥ Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyC3Yu_mU38Ru7PIEGR-2rNSo5FoelowrUQ",
  authDomain: "tuanhh-f16a9.firebaseapp.com",
  projectId: "tuanhh-f16a9",
  storageBucket: "tuanhh-f16a9.appspot.com",
  messagingSenderId: "71969140903",
  appId: "1:71969140903:web:49986baacfbbd1f9e8ab82"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ðŸŒ Azure Translator */
const AZURE_KEY = "6rJ6HYTwtmUotxFYAPRfsyQgJGAhz1G434PD1d8CcS0LC4aYxB7bJQQJ99CBAC3pKaRXJ3w3AAAbACOGZpu7";
const AZURE_REGION = "eastasia";
const AZURE_ENDPOINT = "https://api.cognitive.microsofttranslator.com";

/* admin */
const ADMIN_KEY = "123456";
const params = new URLSearchParams(window.location.search);
const isAdmin = params.get("admin") === ADMIN_KEY;


/* user language */
function getUserLang(){
  return (navigator.language || "en").split("-")[0];
}

/* detect language */
async function detectLanguage(text){
  const res = await fetch(AZURE_ENDPOINT + "/detect?api-version=3.0",{
    method:"POST",
    headers:{
      "Ocp-Apim-Subscription-Key":AZURE_KEY,
      "Ocp-Apim-Subscription-Region":AZURE_REGION,
      "Content-Type":"application/json"
    },
    body:JSON.stringify([{Text:text}])
  });
  const data = await res.json();
  return data[0]?.language || "en";
}

/* translate */
async function translateText(text,to){
  const res = await fetch(AZURE_ENDPOINT + `/translate?api-version=3.0&to=${to}`,{
    method:"POST",
    headers:{
      "Ocp-Apim-Subscription-Key":AZURE_KEY,
      "Ocp-Apim-Subscription-Region":AZURE_REGION,
      "Content-Type":"application/json"
    },
    body:JSON.stringify([{Text:text}])
  });
  const data = await res.json();
  return data[0]?.translations[0]?.text || text;
}

/* post */
window.postStatus = async ()=>{
  const text = statusInput.value.trim();
  let nickname = nicknameInput.value.trim();

  if(!text) return alert("Write something!");
  if(!nickname) nickname="Anonymous";

  await addDoc(collection(db,"statuses"),{
    text,nickname,time:serverTimestamp()
  });

  statusInput.value="";
};

/* delete */
window.deleteStatus = async id=>{
  if(confirm("Delete this post?"))
    await deleteDoc(doc(db,"statuses",id));
};

/* realtime */
const q = query(collection(db,"statuses"),orderBy("time","desc"));

onSnapshot(q,snapshot=>{
  posts.innerHTML="";

  let docs = snapshot.docs;
  if(shuffleMode){
    docs=[...docs];
    shuffleArray(docs);
  }

  docs.forEach(docSnap=>{
    const data = docSnap.data();

    const div=document.createElement("div");
    div.className="post";

    const name=document.createElement("div");
    name.className="name";
    name.textContent=data.nickname;

    const content=document.createElement("div");
    content.className="content";

    const full=data.text;
    const short=full.slice(0,200);
    const long=full.length>200;

    content.textContent= long ? short+"..." : full;

    div.appendChild(name);
    div.appendChild(content);

    /* expand */
    if(long){
      const expand=document.createElement("span");
      expand.className="moreBtn";
      expand.textContent="Expand";
      let ex=false;

      expand.onclick=()=>{
        ex=!ex;
        content.textContent=ex?full:short+"...";
        expand.textContent=ex?"Shorten":"Expand";
      };

      div.appendChild(expand);
    }

    /* translate */
    const translate=document.createElement("span");
    translate.className="moreBtn";
    translate.textContent="Translate";

    let translated=false;
    const userLang=getUserLang();

    translate.onclick=async()=>{
      if(!translated){
        translate.textContent="...";
        const source=await detectLanguage(full);

        if(source===userLang){
          translate.textContent="Same";
          setTimeout(()=>translate.textContent="Translate",1200);
          return;
        }

        const t=await translateText(full,userLang);
        content.textContent=t;
        translate.textContent="Original";
        translated=true;
      }else{
        content.textContent= long? short+"..." : full;
        translate.textContent="Translate";
        translated=false;
      }
    };

    div.appendChild(translate);

    /* admin delete */
    if(isAdmin){
      const del=document.createElement("button");
      del.className="deleteBtn";
      del.textContent="Delete";
      del.onclick=()=>deleteStatus(docSnap.id);
      div.appendChild(del);
    }

    posts.appendChild(div);
  });
});
</script>
</body>
</html>

